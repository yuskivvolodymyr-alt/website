<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <title>Dashboard - QubeNode Validator</title>
    
    <!-- Dashboard Styles (CSP Compliant) -->
    <link href="dashboard-styles.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            color: white;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Animated background like index.html */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: radial-gradient(ellipse at 50% 50%, rgba(0, 212, 255, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 20%, rgba(0, 255, 240, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at 20% 80%, rgba(0, 128, 255, 0.15) 0%, transparent 50%);
            animation: bgShift 20s ease infinite;
            pointer-events: none;
        }
        
        @keyframes bgShift {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }
        
        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 1;
            pointer-events: none;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            border: 1px solid rgba(0,212,255,0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
        }
        
        .section {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }
        
        .btn-quick {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-delegate {
            background: linear-gradient(135deg, #00D4FF, #00FFF0);
            color: #000;
        }
        
        .btn-claim-all {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }
        
        .delegation-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .delegation-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }
        
        .validator-name {
            font-size: 18px;
            font-weight: 600;
            color: #00D4FF;
        }
        
        .delegation-amount {
            font-size: 20px;
            font-weight: 600;
            color: #00FFF0;
        }
        
        .pending-rewards {
            color: #86efac;
            font-size: 14px;
            margin-top: 8px;
        }
        
        .delegation-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .btn-action {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-stake {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
        }
        
        .btn-switch {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }
        
        .btn-unbond {
            background: linear-gradient(135deg, #991b1b, #7f1d1d);
            color: white;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            margin: 3% auto;
            padding: 0;
            border: 2px solid rgba(0,212,255,0.4);
            border-radius: 20px;
            width: 90%;
            max-width: 520px;
            box-shadow: 0 20px 60px rgba(0,212,255,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        .close {
            position: absolute;
            right: 24px;
            color: #64748b;
            font-size: 32px;
            cursor: pointer;
            line-height: 1;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: #ef4444;
        }
        
        .modal-body {
            padding: 28px;
        }
        
        .modal-footer {
            padding: 20px 28px;
            border-top: 1px solid rgba(255,255,255,0.08);
            display: flex;
            gap: 12px;
        }
        
        .validator-info-box {
            background: rgba(0,212,255,0.08);
            border: 1px solid rgba(0,212,255,0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }
        
        .validator-list-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .validator-list-item:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(0,212,255,0.5);
        }
        
        .validator-list-item.selected {
            background: rgba(0,212,255,0.15);
            border-color: rgba(0,212,255,0.6);
        }
        
        .warning-box {
            background: rgba(245,158,11,0.08);
            border: 1px solid rgba(245,158,11,0.3);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 20px;
        }
        
        .warning-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fbbf24;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .warning-item:last-child {
            margin-bottom: 0;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 16px;
            background: rgba(255,255,255,0.03);
            border: 2px solid rgba(0,212,255,0.3);
            border-radius: 12px;
            color: white;
            font-size: 20px;
            text-align: center;
            font-weight: 500;
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: rgba(0,212,255,0.6);
            background: rgba(255,255,255,0.05);
        }
        
        select {
            width: 100%;
            padding: 14px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: white;
            font-size: 14px;
        }
        
        .btn-cancel {
            flex: 1;
            padding: 14px;
            background: #475569;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-cancel:hover {
            background: #5a6a7f;
        }
        
        .btn-confirm {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-confirm.cyan {
            background: linear-gradient(135deg, #00D4FF, #00FFF0);
            color: #000;
        }
        
        .btn-confirm.green {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }
        
        .btn-confirm.red {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .rewards-list {
            background: rgba(245,158,11,0.05);
            border: 1px solid rgba(245,158,11,0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .reward-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .reward-item:last-child {
            border-bottom: none;
        }
        
        .total-rewards {
            background: rgba(245,158,11,0.15);
            border: 1px solid rgba(245,158,11,0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .total-rewards-label {
            color: #fbbf24;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .total-rewards-amount {
            color: #fbbf24;
            font-size: 32px;
            font-weight: 700;
        }
        
        /* MOBILE STYLES */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            /* Dashboard Header - –ø—Ä–∞–≤–∏–ª—å–Ω–µ —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è */
            .dashboard-header {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .dashboard-header > div:first-child {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 15px;
            }
            
            .dashboard-header h1 {
                font-size: 1.5em !important;
                text-align: center;
                width: 100%;
            }
            
            .dashboard-header a[href="index.html"] {
                order: -1 !important; /* –ö–Ω–æ–ø–∫–∞ "–ù–∞ –≥–æ–ª–æ–≤–Ω—É" –ø–µ—Ä—à–æ—é */
                align-self: flex-start !important;
            }
            
            .dashboard-header p {
                font-size: 12px !important;
                text-align: center;
                width: 100%;
            }
            
            .dashboard-header button {
                width: 100%;
                margin-top: 10px;
            }
            
            /* Stats grid - –∫—Ä–∞—â–µ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É */
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px 10px;
            }
            
            .stat-value {
                font-size: 18px !important;
            }
            
            /* Quick Actions - –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è d—É–∂–æ–∫ */
            .quick-actions {
                gap: 10px !important;
            }
            
            .quick-action-btn {
                padding: 12px 16px !important;
                font-size: 13px !important;
                white-space: normal !important;
                min-height: 60px;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
            }
            
            /* Delegations - 2 —Ü–∏—Ñ—Ä–∏ –ø—ñ—Å–ª—è –∫—Ä–∞–ø–∫–∏ */
            .delegation-card {
                padding: 15px !important;
            }
            
            .delegation-amount {
                font-size: 22px !important;
                word-break: break-word;
            }
            
            /* –ö–Ω–æ–ø–∫–∏ d–µ–ª–µ–≥–∞—Ü—ñ–π - –æd–Ω–∞–∫–æ–≤–æ—ó —à–∏—Ä–∏–Ω–∏ */
            .delegation-actions {
                display: flex;
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }
            
            .delegation-actions button {
                width: 100% !important;
                padding: 10px !important;
                font-size: 13px !important;
            }
            
            /* –ú–û–î–ê–õ–¨–ù–Ü –í–Ü–ö–ù–ê - –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è */
            .modal-content {
                width: 95% !important;
                max-width: 95% !important;
                padding: 20px 15px !important;
                max-height: 90vh;
                overflow-y: auto;
                margin: 20px auto;
            }
            
            .modal-header {
                padding-right: 45px !important; /* –ú—ñ—Å—Ü–µ d–ª—è —Ö—Ä–µ—Å—Ç–∏–∫–∞ */
                margin-bottom: 15px !important;
            }
            
            .modal-header h2 {
                font-size: 1.3em !important;
                word-wrap: break-word;
            }
            
            .modal-close {
                top: 15px !important;
                right: 15px !important;
                width: 35px !important;
                height: 35px !important;
                font-size: 24px !important;
                z-index: 1000;
            }
            
            /* –§–æ—Ä–º–∏ –≤ –º–æd–∞–ª–∫–∞—Ö */
            .modal-content input,
            .modal-content select {
                font-size: 16px !important; /* –ó–∞–ø–æ–±—ñ–≥–∞—î zoom –Ω–∞ iOS */
            }
            
            /* –ö–Ω–æ–ø–∫–∏ –≤ –º–æd–∞–ª–∫–∞—Ö */
            .modal-actions {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .modal-actions button {
                width: 100% !important;
            }
            
            /* Transaction Status Modal */
            .transaction-status {
                padding: 15px !important;
            }
            
            .transaction-hash {
                font-size: 11px !important;
                word-break: break-all;
            }
            
            /* Validator List –≤ Switch Modal */
            .validator-item {
                padding: 12px !important;
                font-size: 13px !important;
            }
            
            .validator-commission {
                font-size: 12px !important;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="bg-animation"></div>
    <div class="grid-overlay"></div>
    
    <div class="container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="dashboard-header-row">
                <h1 class="dashboard-title">üíé Your Staking Dashboard</h1>
                <a href="index.html" class="back-btn">üè† To Main</a>
            </div>
            <p class="wallet-address-row">Address: <span id="walletAddress" class="wallet-address-value">Loading...</span></p>
            <button id="disconnectWalletBtn" class="disconnect-btn">üö™ Disconnect Wallet</button>
        </div>
        
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card stat-card-blue">
                <div class="stat-label">üí∞ BALANCE</div>
                <div class="stat-value stat-value-blue"><span id="balance">0.000</span> TICS</div>
            </div>
            <div class="stat-card stat-card-green">
                <div class="stat-label">üíé DELEGATED</div>
                <div class="stat-value stat-value-green"><span id="delegated">0.000</span> TICS</div>
            </div>
            <div class="stat-card stat-card-green">
                <div class="stat-label">‚ú® REWARDS</div>
                <div class="stat-value stat-value-green"><span id="rewards">0.000</span> TICS</div>
            </div>
            <div class="stat-card stat-card-red">
                <div class="stat-label">‚è≥ UNBONDING</div>
                <div class="stat-value stat-value-red"><span id="unbonding">0.000</span> TICS</div>
            </div>
        </div>
        
        <!-- Forecast -->
        <div class="section">
            <h4 class="section-title">üìä Rewards Forecast</h4>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Per day</div>
                    <div class="stat-value stat-value-green-light"><span id="forecastDaily">0.000</span> TICS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Per week</div>
                    <div class="stat-value stat-value-green-light"><span id="forecastWeekly">0.000</span> TICS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Per month</div>
                    <div class="stat-value stat-value-green-light"><span id="forecastMonthly">0.000</span> TICS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Per year</div>
                    <div class="stat-value stat-value-green-light"><span id="forecastYearly">0.000</span> TICS</div>
                </div>
            </div>
            <p class="forecast-note">* APY ~30%, validator commission already included. Calculation provided without compound interest.</p>
        </div>
        
        <!-- Quick Actions -->
        <div class="section">
            <h4 class="section-title">üíé Quick Actions</h4>
            <div class="quick-actions">
                <button class="btn-quick btn-delegate">
                    Delegate to QubeNode
                </button>
                <button class="btn-quick btn-claim-all">
                    <div class="flex-column-centered">
                        <span>Claim All Rewards</span>
                        <span class="quick-action-amount"><span id="quickClaimAmount">0.000</span> TICS</span>
                    </div>
                </button>
            </div>
        </div>
        
        <!-- My Delegations -->
        <div class="section">
            <h4 class="section-title">üìã My Delegations</h4>
            <div id="delegationsList">
                <div class="empty-state">Loading delegations...</div>
            </div>
        </div>
        
        <!-- Unbonding Delegations -->
        <div class="section" id="unbondingSection" class="hidden">
            <h4 class="section-title section-title-red">‚è≥ Unbonding Delegations</h4>
            <div id="unbondingList"></div>
        </div>
    </div>
    
    <!-- MODALS -->
    
    <!-- Stake More / Delegate Modal -->
    <div id="stakeMoreModal" class="modal">
        <div class="modal-content modal-content-blue">
            <div class="modal-header" class="padding-medium">
                <h3 class="modal-title-blue">
                    <span class="modal-icon">üíé</span>
                    <span>Delegate TICS</span>
                </h3>
                <span class="close" id="closeStakeMoreModal">&times;</span>
            </div>
            <div class="modal-body" class="padding-large">
                <div class="validator-info-box" class="padding-compact">
                    <div class="validator-name" id="stakeMoreValidatorName"></div>
                    <div class="validator-address" id="stakeMoreValidatorAddr"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount to delegate (TICS)</label>
                    <input type="number" id="stakeMoreAmount" placeholder="0.00" step="0.001">
                </div>
                
                <div class="balance-row">
                    <span>Minimum: 0.1 TICS</span>
                    <span>Available: <span id="stakeMoreAvailable">0.000</span> TICS</span>
                </div>
                
                <div class="checkbox-container">
                    <label class="checkbox-label">
                        <input type="checkbox" checked class="checkbox-input">
                        <span>You will start receiving rewards immediately after delegation</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer" class="padding-medium">
                <button class="btn-cancel" id="cancelStakeMore">Cancel</button>
                <button class="btn-confirm cyan" id="confirmStakeMore">Delegate</button>
            </div>
        </div>
    </div>
    
    <!-- Claim All Rewards Modal -->
    <div id="claimAllModal" class="modal">
        <div class="modal-content modal-content-yellow">
            <div class="modal-header">
                <h3 class="modal-title-yellow">üí∞ Claim Rewards</h3>
                <span class="close" id="closeClaimAllModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="total-rewards">
                    <div class="total-rewards-label">Total Rewards:</div>
                    <div class="total-rewards-amount"><span id="claimTotalAmount">0.0000</span> TICS</div>
                </div>
                
                <div class="rewards-intro">Rewards from validators:</div>
                <div class="rewards-list" id="claimRewardsList"></div>
                
                <div class="checkbox-container-large">
                    <label class="checkbox-label-large">
                        <input type="checkbox" checked class="checkbox-input-large">
                        <span>All rewards will be claimed in one transaction</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="cancelClaimAll">Cancel</button>
                <button class="btn-confirm green" id="confirmClaimAll">Claim</button>
            </div>
        </div>
    </div>
    
    <!-- Switch Validator Modal - Step 1 -->
    <div id="switchValidatorModal" class="modal">
        <div class="modal-content modal-content-blue">
            <div class="modal-header" class="padding-medium">
                <h3 class="modal-title-blue">
                    <span class="modal-icon">üîÑ</span>
                    <span>Switch Validator</span>
                </h3>
                <span class="close" id="closeSwitchModal1">&times;</span>
            </div>
            <div class="modal-body" class="padding-large">
                <div class="margin-bottom-15">
                    <div class="switch-from-label">From:</div>
                    <div class="validator-info-box" class="validator-info-box-medium">
                        <div class="validator-name" id="switchFromValidatorName"></div>
                        <div class="switch-validator-staked">Staked: <span id="switchFromStaked">0.0000</span> TICS</div>
                    </div>
                </div>
                
                <div class="switch-to-label">Select Validator:</div>
                <div id="validatorsList" class="validators-list-scrollable"></div>
            </div>
            <div class="modal-footer" class="padding-medium">
                <button class="btn-cancel" id="cancelSwitch1">Cancel</button>
                <button class="btn-confirm cyan" id="nextSwitch">Next</button>
            </div>
        </div>
    </div>
    
    <!-- Switch Validator Modal - Step 2 -->
    <div id="switchValidatorModal2" class="modal">
        <div class="modal-content modal-content-blue">
            <div class="modal-header" class="padding-medium">
                <h3 class="modal-title-blue">
                    <span class="modal-icon">üîÑ</span>
                    <span>Switch Validator</span>
                </h3>
                <span class="close" id="closeSwitchModal2">&times;</span>
            </div>
            <div class="modal-body" class="padding-large">
                <div class="form-group">
                    <div class="switch-from-label-small">From:</div>
                    <div class="validator-info-box" class="validator-info-box-small">
                        <div class="switch-validator-name" id="switchFromValidatorName2"></div>
                        <div class="switch-validator-addr" id="switchFromValidatorAddr2"></div>
                        <div class="switch-validator-staked">Staked: <span id="switchFromStaked2">0.0000</span> TICS</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="switch-from-label-small">To:</div>
                    <div class="validator-info-box" class="validator-info-box-small">
                        <div class="switch-validator-name" id="switchToValidatorName"></div>
                        <div class="switch-validator-addr" id="switchToValidatorAddr"></div>
                    </div>
                </div>
                
                <div class="margin-bottom-10">
                    <label class="form-label">Amount (TICS)</label>
                    <input type="number" id="switchAmount" placeholder="0.00" step="0.001">
                </div>
                
                <div class="text-right-balance">
                    Maximum: <span id="switchMaxAmount">0.0000</span> TICS
                </div>
            </div>
            <div class="modal-footer" class="padding-medium">
                <button class="btn-cancel" id="cancelSwitch2">Cancel</button>
                <button class="btn-confirm cyan" id="confirmSwitch">Switch</button>
            </div>
        </div>
    </div>
    
    <!-- Unbond Modal -->
    <div id="unbondModal" class="modal">
        <div class="modal-content modal-content-red">
            <div class="modal-header" class="padding-medium">
                <h3 class="unbond-modal-title">
                    <span class="modal-icon">üîì</span>
                    <span>Unstake TICS</span>
                </h3>
                <span class="close" id="closeUnbondModal">&times;</span>
            </div>
            <div class="modal-body" class="padding-large">
                <div class="validator-info-box unbond-warning-box padding-compact">
                    <div class="unbond-validator-name" id="unbondValidatorName"></div>
                    <div class="switch-validator-staked">Staked: <span id="unbondStaked">0.0000</span> TICS</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount (TICS)</label>
                    <input type="number" id="unbondAmount" placeholder="0.00" step="0.001" class="unbond-input">
                </div>
                
                <div class="text-right-balance">
                    Staked: <span id="unbondMaxAmount">0.0000</span> TICS
                </div>
                
                <div class="warning-box" class="validator-info-box-medium">
                    <div class="warning-item" class="warning-item-small">‚ö†Ô∏è You will NOT earn rewards during unbonding</div>
                    <div class="warning-item" class="warning-item-small">‚ö†Ô∏è Tokens will be locked for 14 days</div>
                    <div class="warning-item" class="warning-item-no-margin">‚ö†Ô∏è You can cancel unbonding before completion</div>
                </div>
            </div>
            <div class="modal-footer" class="padding-medium">
                <button class="btn-cancel" id="cancelUnbond">Cancel</button>
                <button class="btn-confirm red" id="confirmUnbond">Unstake</button>
            </div>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content success-modal-content">
            <div class="modal-header success-modal-header">
                <h3 class="success-modal-title">‚úÖ Success! TX: <span id="successMessage"></span></h3>
                <span class="close" id="closeSuccessModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="success-modal-body">
                    <div class="success-icon">‚úÖ</div>
                    <div class="success-title" id="successTitle">Transaction successful!</div>
                    <div class="success-tx-label">Transaction hash:</div>
                    <div class="success-tx-hash" id="successTxHash"></div>
                    <a id="successExplorerLink" href="#" target="_blank" class="success-explorer-link">üîç View in Explorer</a>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-confirm cyan success-ok-button" id="successOK">OK</button>
            </div>
        </div>
    </div>
    
    <!-- CSP Compliant: DOM Helper Functions -->
    <script src="dashboard-dom-helpers.js"></script>
    
    <!-- CSP Compliant: Safe Function Overrides -->
    <script src="dashboard-functions.js"></script>
    
    <script>
        const QUBENODE_VALIDATOR = 'qubeticsvaloper1tzk9f84cv2gmk3du3m9dpxcuph70sfj6uf6kld';
        let cosmosStaking = null;
        let validatorNamesCache = {};
        let currentValidatorAddress = '';
        let selectedSwitchValidator = '';
        let allValidators = [];
        
        // Initialize
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const walletType = urlParams.get('wallet');
            const address = urlParams.get('address');
            
            if (!walletType || !address) {
                alert('No wallet information. Return to main page.');
                window.location.href = 'index.html';
                return;
            }
            
            document.getElementById('walletAddress').textContent = address;
            
            // Wait for modules
            let attempts = 0;
            while (typeof CosmosStakingModule === 'undefined' && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (typeof CosmosStakingModule === 'undefined') {
                alert('Error loading modules');
                return;
            }
            
            cosmosStaking = new CosmosStakingModule();
            await cosmosStaking.initialize();
            
            const result = await cosmosStaking.connectWallet(walletType);
            if (!result.success) {
                alert('Wallet connection error');
                return;
            }
            
            await loadData();
        }
        
        async function loadData() {
            try {
                const overview = await cosmosStaking.refresh();
                
                // Preload all validator names to cache
                await preloadAllValidators();
                
                // Update stats
                document.getElementById('balance').textContent = formatTics(overview.balance);
                document.getElementById('delegated').textContent = formatTics(overview.totalDelegated);
                document.getElementById('rewards').textContent = formatTics(overview.totalRewards);
                
                // Fix NaN for unbonding
                const unbondingAmount = overview.totalUnbonding && overview.totalUnbonding !== '0' ? formatTics(overview.totalUnbonding) : '0.000';
                document.getElementById('unbonding').textContent = unbondingAmount;
                
                document.getElementById('quickClaimAmount').textContent = formatTics(overview.totalRewards);
                
                // Forecast
                const delegated = parseFloat(overview.totalDelegated) / 1e18;
                const apy = 0.285;
                const daily = (delegated * apy) / 365;
                document.getElementById('forecastDaily').textContent = daily.toFixed(3);
                document.getElementById('forecastWeekly').textContent = (daily * 7).toFixed(3);
                document.getElementById('forecastMonthly').textContent = (daily * 30).toFixed(3);
                document.getElementById('forecastYearly').textContent = (delegated * apy).toFixed(3);
                
                await loadDelegationsSafe(overview);
                await loadUnbondingSafe(overview.unbonding || []);
                
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data: ' + error.message);
            }
        }
        
        
        // Preload all validators to cache their names
        async function preloadAllValidators() {
            try {
                console.log('üîÑ Preloading all validators...');
                const response = await fetch('https://swagger.qubetics.com/cosmos/staking/v1beta1/validators?status=BOND_STATUS_BONDED');
                const data = await response.json();
                
                if (data.validators && Array.isArray(data.validators)) {
                    data.validators.forEach(validator => {
                        if (validator.description && validator.description.moniker) {
                            validatorNamesCache[validator.operator_address] = validator.description.moniker;
                        }
                    });
                    console.log('‚úÖ Loaded', Object.keys(validatorNamesCache).length, 'validator names');
                }
            } catch (error) {
                console.error('‚ùå Error preloading validators:', error);
                // Not critical, continue anyway
            }
        }
        
        async function loadValidatorName(address) {
            try {
                const response = await fetch(`https://swagger.qubetics.com/cosmos/staking/v1beta1/validators/${address}`);
                const data = await response.json();
                if (data.validator && data.validator.description) {
                    validatorNamesCache[address] = data.validator.description.moniker || address;
                    await loadData();
                }
            } catch (error) {
                console.error('Error loading validator name:', error);
            }
        }
        
            const tics = parseFloat(amount) / 1e18;
            if (isNaN(tics)) return '0.000';
            
            // –ù–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É 2 —Ü–∏—Ñ—Ä–∏, –Ω–∞ d–µ—Å–∫—Ç–æ–ø—ñ 3
            const isMobile = window.innerWidth <= 768;
            return tics.toFixed(isMobile ? 2 : 3);
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            // –û—á–∏—â–µ–Ω–Ω—è errorMessage —Ç–∞ –≤—ñd–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É d–ª—è successModal
            if (modalId === 'successModal') {
                const errorMsg = document.getElementById('errorMessage');
                if (errorMsg) {
                    errorMsg.remove();
                }
                // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Å—Ç–∞–Ωd–∞—Ä—Ç–Ω–∏–π —Å—Ç–∞–Ω (–Ω–∞ –≤–∏–ø–∞d–æ–∫ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è)
                setTimeout(() => {
                    const titleElement = document.getElementById('successTitle');
                    if (titleElement) {
                        titleElement.style.color = '#22c55e';
                        titleElement.textContent = 'Transaction successful!';
                    }
                }, 300);
            }
        }
        
        function showSuccess(title, txHash) {
            // –î–æd–∞—î–º–æ 0x —è–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞—î
            const txHashWithPrefix = txHash.startsWith('0x') ? txHash : `0x${txHash}`;
            
            document.getElementById('successTitle').textContent = '‚è≥ Checking status...';
            document.getElementById('successTitle').style.color = '#f59e0b';
            document.getElementById('successTxHash').textContent = txHashWithPrefix;
            document.getElementById('successExplorerLink').href = `https://ticsscan.com/txn/${txHashWithPrefix}`;
            document.getElementById('successModal').style.display = 'block';
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤
            checkTransactionStatus(txHashWithPrefix, title);
        }
        
        async function checkTransactionStatus(txHash, originalTitle) {
            const txHashForApi = txHash.startsWith('0x') ? txHash.substring(2) : txHash;
            let attempts = 0;
            const maxAttempts = 6; // 6 attempts x 2 seconds = 12 seconds
            
            while (attempts < maxAttempts) {
                try {
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds
                    attempts++;
                    
                    console.log(`üîç Checking transaction status (attempt ${attempts}/${maxAttempts})...`);
                    
                    const response = await fetch(`https://swagger.qubetics.com/cosmos/tx/v1beta1/txs/${txHashForApi}`);
                    
                    if (!response.ok) {
                        console.log('‚ö†Ô∏è Transaction not yet indexed, trying again...');
                        continue;
                    }
                    
                    const data = await response.json();
                    
                    if (!data.tx_response) {
                        console.log('‚ö†Ô∏è No tx_response yet, trying again...');
                        continue;
                    }
                    
                    // –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –∑–Ω–∞–πd–µ–Ω–∞, –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å
                    if (data.tx_response.code !== 0) {
                        // FAILED
                        const errorMsg = data.tx_response.raw_log || 'Transaction failed';
                        
                        document.getElementById('successTitle').textContent = '‚ùå Transaction failed';
                        document.getElementById('successTitle').style.color = '#ef4444';
                        
                        // –î–æd–∞—î–º–æ –ø–æ–≤—ñd–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
                        const txHashElement = document.getElementById('successTxHash').parentElement;
                        if (!document.getElementById('errorMessage')) {
                            const errorDiv = document.createElement('div');
                            errorDiv.id = 'errorMessage';
                            errorDiv.style.cssText = 'background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; padding: 12px; margin-top: 16px; color: #fca5a5; font-size: 13px;';
                            errorDiv.innerHTML = `<strong>Reason:</strong><br>${errorMsg}`;
                            txHashElement.parentElement.insertBefore(errorDiv, txHashElement.nextSibling);
                        }
                        
                        console.log('‚ùå Transaction failed:', errorMsg);
                        return; // –í–∏—Ö–æd–∏–º–æ –∑ —Ñ—É–Ω–∫—Ü—ñ—ó
                        
                    } else {
                        // SUCCESS
                        document.getElementById('successTitle').textContent = originalTitle;
                        document.getElementById('successTitle').style.color = '#22c55e';
                        console.log('‚úÖ Transaction confirmed successfully');
                        return; // –í–∏—Ö–æd–∏–º–æ –∑ —Ñ—É–Ω–∫—Ü—ñ—ó
                    }
                    
                } catch (error) {
                    console.error('Error checking transaction status:', error);
                    if (attempts >= maxAttempts) {
                        // –Ø–∫—â–æ –≤—Å—ñ —Å–ø—Ä–æ–±–∏ –≤–∏—á–µ—Ä–ø–∞–Ω—ñ - –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–ø–µ—Ä–µd–∂–µ–Ω–Ω—è
                        document.getElementById('successTitle').textContent = '‚ö†Ô∏è ' + originalTitle + ' (check status in explorer)';
                        document.getElementById('successTitle').style.color = '#f59e0b';
                    }
                }
            }
            
            // –Ø–∫—â–æ –≤—Å—ñ —Å–ø—Ä–æ–±–∏ –≤–∏—á–µ—Ä–ø–∞–Ω—ñ –∞–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –Ω–µ –∑–Ω–∞–πd–µ–Ω–∞
            document.getElementById('successTitle').textContent = '‚ö†Ô∏è ' + originalTitle + ' (check status in explorer)';
            document.getElementById('successTitle').style.color = '#f59e0b';
            console.log('‚ö†Ô∏è Could not verify transaction status after all attempts');
        }
        
        // Stake More
        function stakeMore(validatorAddress, stakedAmount) {
            console.log('üéØ Stake More clicked for:', validatorAddress);
            currentValidatorAddress = validatorAddress;
            
            const valName = validatorNamesCache[validatorAddress] || validatorAddress;
            document.getElementById('stakeMoreValidatorName').textContent = valName;
            document.getElementById('stakeMoreValidatorAddr').textContent = validatorAddress;
            
            const balance = document.getElementById('balance').textContent;
            document.getElementById('stakeMoreAvailable').textContent = balance;
            document.getElementById('stakeMoreAmount').value = '';
            
            document.getElementById('stakeMoreModal').style.display = 'block';
        }
        
        async function confirmStakeMore() {
            const amount = document.getElementById('stakeMoreAmount').value;
            if (!amount || isNaN(amount) || parseFloat(amount) < 0.1) {
                alert('Minimum amount: 0.1 TICS');
                return;
            }
            
            closeModal('stakeMoreModal');
            
            try {
                console.log('üì§ Delegating to:', currentValidatorAddress);
                console.log('üí∞ Amount:', amount, 'TICS');
                
                // Get validator name for memo
                let validatorName = 'Validator';
                if (validatorNamesCache[currentValidatorAddress]) {
                    validatorName = validatorNamesCache[currentValidatorAddress];
                }
                
                const memoText = `Delegate to ${validatorName} via QubeNode.space`;
                const amountMinimal = String((parseFloat(amount) * 1e18).toFixed(0));
                
                // Direct call to stakingService - ORIGINAL WAY
                const stakingService = cosmosStaking.stakingService;
                const result = await stakingService.delegate(currentValidatorAddress, amountMinimal, memoText);
                
                showSuccess('Delegation successful!', result.txHash);
                await loadData();
            } catch (error) {
                console.error('Stake error:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        // Quick Delegate to QubeNode
        function quickDelegateQubeNode() {
            stakeMore(QUBENODE_VALIDATOR, '0');
        }
        
        // Claim All
        async function quickClaimAll() {
            try {
                const overview = await cosmosStaking.refresh();
                
                if (!overview.rewards || !overview.rewards.rewards || overview.rewards.rewards.length === 0) {
                    alert('No rewards to claim');
                    return;
                }
                
                // Fill modal
                document.getElementById('claimTotalAmount').textContent = formatTics(overview.totalRewards);
                
                let rewardsHtml = '';
                for (const reward of overview.rewards.rewards) {
                    const valAddr = reward.validator_address;
                    const valName = validatorNamesCache[valAddr] || valAddr.substring(0, 20) + '...';
                    
                    if (reward.reward && reward.reward.length > 0) {
                        const ticsReward = reward.reward.find(r => r.denom === 'tics');
                        if (ticsReward) {
                            const rewardAmount = formatTics(ticsReward.amount);
                            rewardsHtml += `
                                <div class="reward-item">
                                    <div style="color: white; font-weight: 500;">${valName}</div>
                                    <div style="color: #fbbf24; font-weight: 600;">${rewardAmount} TICS</div>
                                </div>
                            `;
                        }
                    }
                }
                
                document.getElementById('claimRewardsList').innerHTML = rewardsHtml;
                document.getElementById('claimAllModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        }
        
        async function confirmClaimAll() {
            closeModal('claimAllModal');
            
            try {
                const overview = await cosmosStaking.refresh();
                
                // Get all validator addresses with rewards
                const validatorAddresses = overview.rewards.rewards
                    .filter(r => r.reward && r.reward.length > 0)
                    .map(r => r.validator_address);
                
                if (validatorAddresses.length === 0) {
                    alert('No rewards to claim');
                    return;
                }
                
                console.log('Claiming from validators:', validatorAddresses);
                
                // Build memo with validator count and names (if short enough)
                const validatorCount = validatorAddresses.length;
                let memoText = `Claim from ${validatorCount} validator${validatorCount > 1 ? 's' : ''}`;
                
                // Try to add first few validator names if memo stays short
                const firstNames = validatorAddresses
                    .slice(0, 3) // First 3 validators
                    .map(addr => validatorNamesCache[addr] || addr.substring(0, 15))
                    .join(', ');
                
                const testMemo = `${memoText}: ${firstNames}${validatorCount > 3 ? '...' : ''} via QubeNode.space`;
                
                // Only use detailed memo if under 200 chars (safe limit)
                if (testMemo.length < 200) {
                    memoText = testMemo;
                } else {
                    memoText = `${memoText} via QubeNode.space`;
                }
                
                console.log('Memo:', memoText);
                
                const result = await cosmosStaking.claimRewards(memoText, validatorAddresses);
                showSuccess('Rewards claimed!', result.txHash);
                await loadData();
            } catch (error) {
                console.error('Claim error:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        // Switch Validator
        async function switchValidator(validatorAddress, stakedAmount) {
            console.log('üîÑ Switch Validator clicked for:', validatorAddress);
            currentValidatorAddress = validatorAddress;
            
            const valName = validatorNamesCache[validatorAddress] || validatorAddress;
            document.getElementById('switchFromValidatorName').textContent = valName;
            document.getElementById('switchFromStaked').textContent = stakedAmount;
            
            // Load all validators
            await loadAllValidators();
            
            document.getElementById('switchValidatorModal').style.display = 'block';
        }
        
        async function loadAllValidators() {
            try {
                const response = await fetch('https://swagger.qubetics.com/cosmos/staking/v1beta1/validators?status=BOND_STATUS_BONDED');
                const data = await response.json();
                allValidators = data.validators || [];
                
                // Sort validators: QubeNode first, then others
                const qubenodeAddr = 'qubeticsvaloper1tzk9f84cv2gmk3du3m9dpxcuph70sfj6uf6kld';
                const sortedValidators = allValidators.filter(v => v.operator_address !== currentValidatorAddress).sort((a, b) => {
                    if (a.operator_address === qubenodeAddr) return -1;
                    if (b.operator_address === qubenodeAddr) return 1;
                    return 0;
                });
                
                // Use safe DOM version instead of innerHTML
                populateValidatorsListSafe(sortedValidators);
            } catch (error) {
                console.error('Error loading validators:', error);
            }
        }
        
        function selectValidator(address, name) {
            selectedSwitchValidator = address;
            
            // Highlight selected
            document.querySelectorAll('.validator-list-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }
        
        function switchValidatorStep2() {
            if (!selectedSwitchValidator) {
                alert('Select validator');
                return;
            }
            
            closeModal('switchValidatorModal');
            
            // Fill step 2
            const fromName = validatorNamesCache[currentValidatorAddress] || currentValidatorAddress;
            const stakedAmount = document.getElementById('switchFromStaked').textContent;
            
            // Get selected validator name from allValidators
            const selectedVal = allValidators.find(v => v.operator_address === selectedSwitchValidator);
            const toName = selectedVal ? selectedVal.description.moniker : selectedSwitchValidator;
            
            document.getElementById('switchFromValidatorName2').textContent = fromName;
            document.getElementById('switchFromValidatorAddr2').textContent = currentValidatorAddress.substring(0, 16) + '...' + currentValidatorAddress.substring(currentValidatorAddress.length - 6);
            document.getElementById('switchFromStaked2').textContent = stakedAmount;
            document.getElementById('switchToValidatorName').textContent = toName;
            document.getElementById('switchToValidatorAddr').textContent = selectedSwitchValidator.substring(0, 16) + '...' + selectedSwitchValidator.substring(selectedSwitchValidator.length - 6);
            document.getElementById('switchMaxAmount').textContent = stakedAmount;
            document.getElementById('switchAmount').value = '';
            
            document.getElementById('switchValidatorModal2').style.display = 'block';
        }
        
        async function confirmSwitch() {
            const amount = document.getElementById('switchAmount').value;
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                alert('Enter valid amount');
                return;
            }
            
            closeModal('switchValidatorModal2');
            
            try {
                const amountMinimal = String((parseFloat(amount) * 1e18).toFixed(0));
                
                console.log('üì§ Redelegating from:', currentValidatorAddress);
                console.log('üì• Redelegating to:', selectedSwitchValidator);
                console.log('üí∞ Amount:', amount, 'TICS');
                
                const walletManager = cosmosStaking.walletManager;
                const chainClient = cosmosStaking.chainClient;
                const txBuilder = cosmosStaking.txBuilder;
                
                // Get validator names
                const fromName = validatorNamesCache[currentValidatorAddress] || 'current validator';
                const toName = validatorNamesCache[selectedSwitchValidator] || 'new validator';
                
                const stakingService = new CosmosStakingService(walletManager, chainClient, txBuilder);
                const memoText = `Redelegate from ${fromName} to ${toName} via QubeNode.space`;
                const result = await stakingService.redelegate(currentValidatorAddress, selectedSwitchValidator, amountMinimal, memoText);
                
                showSuccess('Validator switched!', result.txHash);
                await loadData();
            } catch (error) {
                console.error('Redelegate error:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        // Unbond
        function unbond(validatorAddress, stakedAmount) {
            console.log('‚õî Unbond clicked for:', validatorAddress);
            currentValidatorAddress = validatorAddress;
            
            const valName = validatorNamesCache[validatorAddress] || validatorAddress;
            document.getElementById('unbondValidatorName').textContent = valName;
            document.getElementById('unbondStaked').textContent = stakedAmount;
            document.getElementById('unbondMaxAmount').textContent = stakedAmount;
            document.getElementById('unbondAmount').value = '';
            
            document.getElementById('unbondModal').style.display = 'block';
        }
        
        async function confirmUnbond() {
            const amount = document.getElementById('unbondAmount').value;
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                alert('Enter valid amount');
                return;
            }
            
            closeModal('unbondModal');
            
            try {
                const amountMinimal = String((parseFloat(amount) * 1e18).toFixed(0));
                
                console.log('üì§ Unbonding from:', currentValidatorAddress);
                console.log('üí∞ Amount:', amount, 'TICS');
                console.log('üî¢ Amount Minimal (toFixed):', amountMinimal);
                console.log('üî¢ Type:', typeof amountMinimal);
                
                const walletManager = cosmosStaking.walletManager;
                const chainClient = cosmosStaking.chainClient;
                const txBuilder = cosmosStaking.txBuilder;
                
                // Get validator name
                const validatorName = validatorNamesCache[currentValidatorAddress] || 'validator';
                
                const stakingService = new CosmosStakingService(walletManager, chainClient, txBuilder);
                const memoText = `Undelegate from ${validatorName} via QubeNode.space`;
                const result = await stakingService.undelegate(currentValidatorAddress, amountMinimal, memoText);
                
                showSuccess('Unstake started! Tokens will be available in 14 days', result.txHash);
                await loadData();
            } catch (error) {
                console.error('Unbond error:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        // Cancel Unbonding
        async function cancelUnbonding(validatorAddress, amount, creationHeight) {
            if (!confirm(`Cancel unbond ${formatTics(amount)} TICS? Tokens will return to delegation.`)) {
                return;
            }
            
            try {
                const walletManager = cosmosStaking.walletManager;
                const chainClient = cosmosStaking.chainClient;
                const txBuilder = cosmosStaking.txBuilder;
                
                // Get validator name
                const validatorName = validatorNamesCache[validatorAddress] || 'validator';
                
                const stakingService = new CosmosStakingService(walletManager, chainClient, txBuilder);
                const memoText = `Cancel unbond from ${validatorName} via QubeNode.space`;
                const result = await stakingService.cancelUnbonding(
                    validatorAddress, 
                    amount, 
                    creationHeight, 
                    memoText
                );
                
                showSuccess('Unbond cancelled! Tokens returned to staking', result.txHash);
                await loadData();
            } catch (error) {
                console.error('Cancel unbonding error:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        function disconnectWallet() {
            window.location.href = 'index.html';
        }
        
        // Start
        init();
        
        // Auto-refresh every 10 seconds
        setInterval(async () => {
            if (cosmosStaking) {
                try {
                    await loadData();
                    console.log('üîÑ Dashboard auto-refreshed');
                } catch (error) {
                    console.error('Auto-refresh error:', error);
                }
            }
        }, 10000);
    </script>
    
    <script src="chain-config.js?v=10"></script>
    <script src="wallet-manager.js?v=10"></script>
    <script src="chain-client.js?v=10"></script>
    <script src="transaction-builder.js?v=10"></script>
    <script src="staking-service.js?v=10"></script>
    <script src="cosmos-staking.js?v=10"></script>
    <script src="validators-registry.js?v=10"></script>
    
    <!-- Dashboard Initialization - Event Listeners for CSP Compliance -->
    <script src="init-dashboard.js"></script>
</body>
</html>
